<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PARennial Golf CCTV Feeds</title>
  <link rel="icon" type="image/png" href="logo_mark_gradient_sized.png">
  <link rel="stylesheet" href="styles.css">
</head>

<body class="main-page">
  <div class="header">
    <h1>CCTV Feeds</h1>
    <div class="user-info" id="userInfo"></div>
    <button class="logout-btn" onclick="logout()">Logout</button>
    <div class="nav-links">
      <a href="all-feeds.html">All Feeds</a>
    </div>
  </div>

  <!-- Lincoln Park Section -->
  <div class="section">
    <div class="section-header" onclick="toggleSection('lincoln-park')">
      <span>Lincoln Park CCTV Feeds</span>
      <span class="arrow" id="lincoln-park-arrow">▶</span>
    </div>
    <div class="feeds-container expanded" id="lincoln-park-feeds">
      <div class="feed-item">
        <div class="feed-label">Bay 1</div>
        <iframe src="http://pgl-1:8889/bay_1/" allow="autoplay; fullscreen"></iframe>
      </div>
      <div class="feed-item">
        <div class="feed-label">Bay 2</div>
        <iframe src="http://pgl-1:8889/bay_2/" allow="autoplay; fullscreen"></iframe>
      </div>
      <div class="feed-item">
        <div class="feed-label">Bay 3</div>
        <iframe src="http://pgl-1:8889/bay_3/" allow="autoplay; fullscreen"></iframe>
      </div>
    </div>
  </div>

  <!-- West Loop Section -->
  <div class="section">
    <div class="section-header" onclick="toggleSection('west-loop')">
      <span>West Loop CCTV Feeds</span>
      <span class="arrow" id="west-loop-arrow">▶</span>
    </div>
    <div class="feeds-container" id="west-loop-feeds">
      <div class="feed-item">
        <div class="feed-label">West Loop - Bay 1</div>
        <iframe src="http://pgl-2:8889/bay_1/" allow="autoplay; fullscreen"></iframe>
      </div>
      <div class="feed-item">
        <div class="feed-label">West Loop - Bay 2</div>
        <iframe src="http://pgl-2:8889/bay_2/" allow="autoplay; fullscreen"></iframe>
      </div>
      <div class="feed-item">
        <div class="feed-label">West Loop - Bay 3</div>
        <iframe src="http://pgl-2:8889/bay_3/" allow="autoplay; fullscreen"></iframe>
      </div>
      <div class="feed-item">
        <div class="feed-label">West Loop - Bay 4</div>
        <iframe src="http://pgl-2:8889/bay_4/" allow="autoplay; fullscreen"></iframe>
      </div>
      <div class="feed-item">
        <div class="feed-label">West Loop - Bay 5</div>
        <iframe src="http://pgl-2:8889/bay_5/" allow="autoplay; fullscreen"></iframe>
      </div>
    </div>
  </div>

  <!-- Wicker Park Section -->
  <div class="section">
    <div class="section-header" onclick="toggleSection('wicker-park')">
      <span>Wicker Park CCTV Feeds</span>
      <span class="arrow" id="wicker-park-arrow">▶</span>
    </div>
    <div class="feeds-container" id="wicker-park-feeds">
      <div class="feed-item">
        <div class="feed-label">Wicker Park - Bay 1</div>
        <iframe src="http://pgl-3:8889/bay_1/" allow="autoplay; fullscreen"></iframe>
      </div>
      <div class="feed-item">
        <div class="feed-label">Wicker Park - Bay 2</div>
        <iframe src="http://pgl-3:8889/bay_2/" allow="autoplay; fullscreen"></iframe>
      </div>
      <div class="feed-item">
        <div class="feed-label">Wicker Park - Bay 3</div>
        <iframe src="http://pgl-3:8889/bay_3/" allow="autoplay; fullscreen"></iframe>
      </div>
      <div class="feed-item">
        <div class="feed-label">Wicker Park - Bay 4</div>
        <iframe src="http://pgl-3:8889/bay_4/" allow="autoplay; fullscreen"></iframe>
      </div>
    </div>
  </div>

  <script>
    function toggleSection(sectionId) {
      const feedsContainer = document.getElementById(sectionId + '-feeds');
      const arrow = document.getElementById(sectionId + '-arrow');

      if (feedsContainer.classList.contains('expanded')) {
        feedsContainer.classList.remove('expanded');
        arrow.classList.remove('expanded');
      } else {
        feedsContainer.classList.add('expanded');
        arrow.classList.add('expanded');
      }
    }

    // Initialize Lincoln Park section as expanded
    document.getElementById('lincoln-park-arrow').classList.add('expanded');
    
    // Display current user (after auth sync)
    document.addEventListener('DOMContentLoaded', function() {
      const currentUser = getCurrentUser();
      if (currentUser) {
        document.getElementById('userInfo').textContent = `Welcome, ${currentUser}`;
      }
    });
  </script>
  <script src="auth.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
  <script>
    (async function() {
      const frames = Array.from(document.querySelectorAll('iframe'));
      const candidates = ['index.m3u8', 'stream.m3u8', 'hls.m3u8', 'playlist.m3u8'];
      const canNativeHls = !!document.createElement('video').canPlayType('application/vnd.apple.mpegURL');

      function ensureSlash(u) { return u.endsWith('/') ? u : (u + '/'); }
      function toProxyPrefix(src) {
        try {
          const u = new URL(src, window.location.origin);
          if (u.host && u.host !== window.location.host) {
            return `/proxy/${u.host}${u.pathname}`;
          }
          return u.pathname;
        } catch { return src; }
      }
      async function urlOk(u) {
        try { const r = await fetch(u, { method: 'HEAD' }); return r.ok; } catch { return false; }
      }

      for (const f of frames) {
        const baseSrc = f.getAttribute('src');
        if (!baseSrc) continue;
        const prefix = ensureSlash(toProxyPrefix(baseSrc));
        let playlist = '';
        for (const suf of candidates) {
          const testUrl = prefix + suf;
          // eslint-disable-next-line no-await-in-loop
          if (await urlOk(testUrl)) { playlist = testUrl; break; }
        }
        if (!playlist) continue;

        const video = document.createElement('video');
        video.muted = true;
        video.autoplay = true;
        video.playsInline = true;
        video.controls = true;
        video.style.width = '100%';
        video.style.height = '100%';
        video.style.background = '#000';

        if (canNativeHls) {
          video.src = playlist;
        } else if (window.Hls && window.Hls.isSupported()) {
          const hls = new window.Hls();
          hls.loadSource(playlist);
          hls.attachMedia(video);
        } else {
          continue;
        }
        f.parentNode.replaceChild(video, f);
      }
    })();
  </script>
</body>

</html>

