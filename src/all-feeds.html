<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>All CCTV Feeds - PARennial Golf</title>
  <link rel="icon" type="image/png" href="logo_mark_gradient_sized.png">
  <link rel="stylesheet" href="styles.css">
</head>

<body class="grid-page">
  <div class="header">
    <div class="nav-links">
      <a href="cctv.html">‚Üê</a>
    </div>
    <h1>All CCTV Feeds</h1>
    <div class="user-info" id="userInfo"></div>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <div class="grid-container">
    <!-- Lincoln Park Feeds -->
    <div class="feed-item">
      <div class="feed-label">Lincoln Park - Bay 1</div>
      <iframe src="http://pgl-1:8889/bay_1/" allow="autoplay; fullscreen"></iframe>
    </div>

    <div class="feed-item">
      <div class="feed-label">Lincoln Park - Bay 2</div>
      <iframe src="http://pgl-1:8889/bay_2/" allow="autoplay; fullscreen"></iframe>
    </div>

    <div class="feed-item">
      <div class="feed-label">Lincoln Park - Bay 3</div>
      <iframe src="http://pgl-1:8889/bay_3/" allow="autoplay; fullscreen"></iframe>
    </div>

    <!-- West Loop Feeds -->
    <div class="feed-item">
      <div class="feed-label">West Loop - Bay 1</div>
      <iframe src="http://pgl-2:8889/bay_1/" allow="autoplay; fullscreen"></iframe>
    </div>

    <div class="feed-item">
      <div class="feed-label">West Loop - Bay 2</div>
      <iframe src="http://pgl-2:8889/bay_2/" allow="autoplay; fullscreen"></iframe>
    </div>

    <div class="feed-item">
      <div class="feed-label">West Loop - Bay 3</div>
      <iframe src="http://pgl-2:8889/bay_3/" allow="autoplay; fullscreen"></iframe>
    </div>

    <div class="feed-item">
      <div class="feed-label">West Loop - Bay 4</div>
      <iframe src="http://pgl-2:8889/bay_4/" allow="autoplay; fullscreen"></iframe>
    </div>

    <div class="feed-item">
      <div class="feed-label">West Loop - Bay 5</div>
      <iframe src="http://pgl-2:8889/bay_5/" allow="autoplay; fullscreen"></iframe>
    </div>

    <!-- Wicker Park Feeds -->
    <div class="feed-item">
      <div class="feed-label">Wicker Park - Bay 1</div>
      <iframe src="http://pgl-3:8889/bay_1/" allow="autoplay; fullscreen"></iframe>
    </div>

    <div class="feed-item">
      <div class="feed-label">Wicker Park - Bay 2</div>
      <iframe src="http://pgl-3:8889/bay_2/" allow="autoplay; fullscreen"></iframe>
    </div>

    <div class="feed-item">
      <div class="feed-label">Wicker Park - Bay 3</div>
      <iframe src="http://pgl-3:8889/bay_3/" allow="autoplay; fullscreen"></iframe>
    </div>

    <div class="feed-item">
      <div class="feed-label">Wicker Park - Bay 4</div>
      <iframe src="http://pgl-3:8889/bay_4/" allow="autoplay; fullscreen"></iframe>
    </div>
  </div>

  <script>
    // Display current user after auth sync
    document.addEventListener('DOMContentLoaded', function () {
      const currentUser = getCurrentUser();
      if (currentUser) {
        document.getElementById('userInfo').textContent = `Welcome, ${currentUser}`;
      }
    });
  </script>
  <script src="auth.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
  <script>
    (async function() {
      const frames = Array.from(document.querySelectorAll('iframe'));
      const candidates = ['index.m3u8', 'stream.m3u8', 'hls.m3u8', 'playlist.m3u8'];
      const canNativeHls = !!document.createElement('video').canPlayType('application/vnd.apple.mpegURL');

      function ensureSlash(u) { return u.endsWith('/') ? u : (u + '/'); }
      function toProxyPrefix(src) {
        try {
          const u = new URL(src, window.location.origin);
          if (u.host && u.host !== window.location.host) {
            return `/proxy/${u.host}${u.pathname}`;
          }
          return u.pathname;
        } catch { return src; }
      }
      async function urlOk(u) {
        try { const r = await fetch(u, { method: 'HEAD' }); return r.ok; } catch { return false; }
      }

      for (const f of frames) {
        const baseSrc = f.getAttribute('src');
        if (!baseSrc) continue;
        const prefix = ensureSlash(toProxyPrefix(baseSrc));
        let playlist = '';
        for (const suf of candidates) {
          const testUrl = prefix + suf;
          // eslint-disable-next-line no-await-in-loop
          if (await urlOk(testUrl)) { playlist = testUrl; break; }
        }
        if (!playlist) continue;

        const video = document.createElement('video');
        video.muted = true;
        video.autoplay = true;
        video.playsInline = true;
        video.controls = true;
        video.style.width = '100%';
        video.style.height = '100%';
        video.style.background = '#000';

        if (canNativeHls) {
          video.src = playlist;
        } else if (window.Hls && window.Hls.isSupported()) {
          const hls = new window.Hls();
          hls.loadSource(playlist);
          hls.attachMedia(video);
        } else {
          continue;
        }
        f.parentNode.replaceChild(video, f);
      }
    })();
  </script>
</body>

</html>